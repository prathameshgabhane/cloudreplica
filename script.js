// ============================================================
// Static JSON generated by GitHub Actions (compute + storage)
const API_BASE = "data/prices.json";

// ---------- Defaults for dropdown meta ----------
const FALLBACK_META = {
  os:   [{ value: "Linux" }, { value: "Windows" }],
  vcpu: [1, 2, 4, 8, 16],
  ram:  [1, 2, 4, 8, 16, 32]
};

const HRS_PER_MONTH = 730;

// --- in-memory storage pricing (filled from prices.json; with fallbacks) ---
let STORAGE_CFG = {
  aws:  { region: "us-east-1", ssd_per_gb_month: 0.08, hdd_st1_per_gb_month: 0.045 },
  azure:{ region: "eastus",
          ssd_monthly: {4:0.3,8:0.6,16:1.2,32:2.4,64:4.8,128:9.6,256:19.2,512:38.4},
          hdd_monthly: {32:1.536,64:3.008,128:5.888,256:11.328} }
};

// ============================================================
// Bootstrapping dropdowns (fail-safe + enhance from JSON)
document.addEventListener("DOMContentLoaded", async () => {
  // 1) FAIL-SAFE: show fallbacks immediately so the UI is never blank
  fillSelect("os",   [{ value: "Linux", text: "Linux" }, { value: "Windows", text: "Windows" }]);
  fillSelect("cpu",  [1, 2, 4, 8, 16].map(v => ({ value: v, text: v })));
  fillSelect("ram",  [1, 2, 4, 8, 16, 32].map(v => ({ value: v, text: v })));
  setSelectValue("os", "Linux");
  setSelectValue("cpu", "2");
  setSelectValue("ram", "4");

  // Hooks that don’t depend on prices.json
  ["awsFamily", "azFamily"].forEach(id => {
    const el = document.getElementById(id);
    if (el) el.addEventListener("change", () => compare());
  });

  // Initialize tooltips
  initStorageTypeTooltip();
  initOsTypeTooltip(); // OS tooltip

  // 2) Try to enhance with data/prices.json (overwrites the fallbacks if present)
  try {
    const r = await fetch(API_BASE, { mode: "cors" });
    const j = r.ok ? await r.json() : {};
    const meta = j.meta;

    // pick up storage from file if present
    if (j.storage?.aws || j.storage?.azure) {
      STORAGE_CFG = {
        aws: {
          region: j.storage?.aws?.region ?? STORAGE_CFG.aws.region,
          ssd_per_gb_month: Number(j.storage?.aws?.ssd_per_gb_month ?? STORAGE_CFG.aws.ssd_per_gb_month),
          hdd_st1_per_gb_month: Number(j.storage?.aws?.hdd_st1_per_gb_month ?? STORAGE_CFG.aws.hdd_st1_per_gb_month),
        },
        azure: {
          region: j.storage?.azure?.region ?? STORAGE_CFG.azure.region,
          ssd_monthly: j.storage?.azure?.ssd_monthly ?? STORAGE_CFG.azure.ssd_monthly,
          hdd_monthly: j.storage?.azure?.hdd_monthly ?? STORAGE_CFG.azure.hdd_monthly,
        }
      };
    }

    if (meta) {
      const osItems = Array.isArray(meta.os)
        ? meta.os.map(x => (typeof x === "string" ? { value: x, text: x } : { value: x.value, text: x.value }))
        : [{ value: "Linux", text: "Linux" }, { value: "Windows", text: "Windows" }];

      fillSelect("os",  osItems);
      fillSelect("cpu", (meta.vcpu || [1, 2, 4, 8, 16]).map(v => ({ value: v, text: v })));
      fillSelect("ram", (meta.ram  || [1, 2, 4, 8, 16, 32]).map(v => ({ value: v, text: v })));

      setSelectValue("os", "Linux");
      setSelectValue("cpu", "2");
      setSelectValue("ram", "4");
    }
  } catch {
    // Leave fallbacks as-is
  }

  // 3) Show an initial comparison so the page isn't empty on load
  compare();
});

// ============================================================
// ---------- UI helpers ----------
function fillSelect(id, items) {
  const el = document.getElementById(id);
  if (!el) return;
  el.innerHTML = "";
  for (const it of items) {
    const opt = document.createElement("option");
    opt.value = it.value;
    opt.textContent = it.text;
    el.appendChild(opt);
  }
}
function setSelectValue(id, value) {
  const el = document.getElementById(id);
  if (!el) return;
  const match = Array.from(el.options).find(o => o.value == value);
  if (match) el.value = value;
}
function fmt(n)      { return (n == null || isNaN(n)) ? "—" : `$${Number(n).toFixed(4)}`; }
function monthly(ph) { return (ph == null || isNaN(ph)) ? null : ph * HRS_PER_MONTH; }

function setStatus(msg, level="info") {
  const el = document.getElementById("status");
  if (!el) return;
  // Use CSS var fallbacks so color still applies if --err/--warn not defined
  const err  = "var(--err, #b91c1c)";
  const warn = "var(--warn, #b45309)";
  const mut  = "var(--muted, #666)";
  el.textContent = msg;
  el.style.color = (level === "error") ? err :
                   (level === "warn")  ? warn : mut;
}

function safeSetText(id, text) {
  const el = document.getElementById(id);
  if (el) el.textContent = text;
}
function appendToText(id, extra) {
  const el = document.getElementById(id);
  if (el) el.textContent = (el.textContent || "") + extra;
}
function sumSafe(a, b) {
  const na = (a == null || isNaN(a)) ? 0 : Number(a);
  const nb = (b == null || isNaN(b)) ? 0 : Number(b);
  if (a == null && b == null) return null;
  return na + nb;
}

// ---------- Family UI helpers ----------
function showFamilyFilters() {
  const awsW = document.getElementById("awsFamilyWrap");
  const azW  = document.getElementById("azFamilyWrap");
  if (awsW) awsW.style.display = "flex";
  if (azW)  azW.style.display  = "flex";
}
function resetFamilyFilters() {
  const awsW = document.getElementById("awsFamilyWrap");
  const azW  = document.getElementById("azFamilyWrap");
  const awsS = document.getElementById("awsFamily");
  const azS  = document.getElementById("azFamily");
  if (awsW) awsW.style.display = "none";
  if (azW)  azW.style.display  = "none";
  if (awsS) awsS.value = "";
  if (azS)  azS.value = "";
}

// ---------- Family membership tests (client-side) ----------
function isAwsInFamily(inst, family) {
  if (!family) return true; // Auto
  const s = String(inst || "").toLowerCase();
  if (family === "general")  return /^[mt]/.test(s);       // t*, m*
  if (family === "compute")  return /^c/.test(s);          // c*
  if (family === "memory")   return /^[rxz]/.test(s);      // r*, x*, z*
  return true;
}
function isAzureInFamily(inst, family) {
  if (!family) return true; // Auto
  const n = String(inst || "").toLowerCase();
  let first = null;
  const m = n.match(/standard_([a-z]+)/);  // e.g., "standard_d4s_v5" -> "d4s..."
  if (m && m[1] && m[1].length) first = m[1][0];
  else first = n[0] || null;
  if (!first) return true;

  if (family === "general")  return first === "d" || first === "b"; // D/B
  if (family === "compute")  return first === "f";                  // F
  if (family === "memory")   return first === "e" || first === "m"; // E/M
  return true;
}

// ============================================================
// ---------- Compare using local prices.json ----------
async function compare() {
  const btn = document.getElementById("compareBtn");
  if (btn) btn.disabled = true;
  setStatus("Fetching local prices…");

  const os           = document.getElementById("os")?.value || "Linux";
  const vcpu         = Number(document.getElementById("cpu")?.value ?? 0);
  const ram          = Number(document.getElementById("ram")?.value ?? 0);
  const storageType  = (document.getElementById("storageType")?.value || "hdd").toLowerCase(); // 'ssd' | 'hdd'
  const storageAmtGB = Number(document.getElementById("storageAmt")?.value ?? 0);

  // Family selections ('' = Auto)
  const familyAws = document.getElementById("awsFamily")?.value || "";
  const familyAz  = document.getElementById("azFamily")?.value  || "";

  try {
    resetCards();

    const r = await fetch(API_BASE, { mode: "cors" });
    if (!r.ok) throw new Error(`Failed to read ${API_BASE}`);
    const data = await r.json();

    // --------- AWS selection ----------
    let awsCard;
    try {
      const a = findBestAws(data.aws || [], vcpu, ram, os, familyAws);
      awsCard = a ? {
        instance: a.instance,
        vcpu: a.vcpu,
        ram: a.ram,
        pricePerHourUSD: a.pricePerHourUSD,
        region: a.region
      } : null;
    } catch (e) {
      awsCard = { error: e.message || String(e) };
    }

    // --------- Azure selection ----------
    let azCard;
    try {
      const z = findBestAzure(data.azure || [], vcpu, ram, os, familyAz);
      azCard = z ? {
        instance: z.instance,
        vcpu: z.vcpu ?? vcpu,
        ram:  z.ram  ?? ram,
        pricePerHourUSD: z.pricePerHourUSD,
        region: z.region
      } : null;
    } catch (e) {
      azCard = { error: e.message || String(e) };
    }

    // ---------- STORAGE: show chosen selection on both cards ----------
    const selLabel = `${storageAmtGB} GB ${storageType.toUpperCase()}`;
    safeSetText("awsStorageSel", `Storage: ${selLabel}`);
    safeSetText("azStorageSel",  `Storage: ${selLabel}`);

    // ---------- STORAGE PRICING (from data/prices.json with fallback) ----------
    // Refresh STORAGE_CFG in case workflow updated it since DOMContentLoaded
    if (data.storage?.aws || data.storage?.azure) {
      STORAGE_CFG = {
        aws: {
          region: data.storage?.aws?.region ?? STORAGE_CFG.aws.region,
          ssd_per_gb_month: Number(data.storage?.aws?.ssd_per_gb_month ?? STORAGE_CFG.aws.ssd_per_gb_month),
