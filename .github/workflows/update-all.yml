name: Update All Cloud Prices

permissions:
  contents: write
  # NOTE: top-level permissions do NOT flow into reusable workflows; we set per-job below.

on:
  workflow_dispatch: {}
  schedule:
    - cron: "30 0 * * 1"   # Monday 00:30 UTC

concurrency:
  group: update-all-cloud-prices
  cancel-in-progress: false

jobs:
  # 1) Azure
  azure:
    uses: ./.github/workflows/update-azure.yml
    permissions:
      contents: read
      id-token: write
    secrets: inherit

  # 2) AWS
  aws:
    needs: azure
    uses: ./.github/workflows/update-aws.yml
    permissions:
      contents: read
    secrets: inherit

  # 3) GCP
  gcp:
    needs: aws
    uses: ./.github/workflows/update-gcp.yml
    permissions:
      contents: read
      id-token: write
    secrets: inherit

  # 4) Aggregate
  aggregate:
    needs: gcp
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Ensure jq is available
        run: |
          if ! command -v jq >/dev/null 2>&1; then
            sudo apt-get update -y
            sudo apt-get install -y jq
          fi

      # --- Download artifacts from the SAME run (reusable workflows) ---
      - name: Download Azure artifact
        uses: actions/download-artifact@v4
        with:
          name: azure-prices
          path: _artifacts/azure

      - name: Download AWS artifact
        uses: actions/download-artifact@v4
        with:
          name: aws-prices
          path: _artifacts/aws

      - name: Download GCP artifact
        uses: actions/download-artifact@v4
        with:
          name: gcp-prices
          path: _artifacts/gcp

      # --- Sanity-print what's inside artifacts ---
      - name: List downloaded artifacts
        run: |
          echo "== AZURE ARTIFACT =="
          find _artifacts/azure -maxdepth 4 -type f -print || true
          echo "== AWS ARTIFACT =="
          find _artifacts/aws   -maxdepth 4 -type f -print || true
          echo "== GCP ARTIFACT =="
          find _artifacts/gcp   -maxdepth 4 -type f -print || true

      # --- Validate presence & non-empty JSONs BEFORE staging ---
      - name: Validate provider JSONs are present and non-empty
        shell: bash
        run: |
          set -euo pipefail

          AZ_SRC=$(find _artifacts/azure -name '*.json' -type f | head -n1 || true)
          AW_SRC=$(find _artifacts/aws   -name '*.json' -type f | head -n1 || true)
          GC_SRC=$(find _artifacts/gcp   -name '*.json' -type f | head -n1 || true)

          echo "AZ_SRC=${AZ_SRC}"
          echo "AW_SRC=${AW_SRC}"
          echo "GC_SRC=${GC_SRC}"

          # Fail fast if any provider artifact is missing
          [[ -n "${AZ_SRC}" ]] || { echo "::error::Azure artifact missing (azure-prices)"; exit 1; }
          [[ -n "${AW_SRC}" ]] || { echo "::error::AWS artifact missing (aws-prices)"; exit 1; }
          [[ -n "${GC_SRC}" ]] || { echo "::error::GCP artifact missing (gcp-prices)"; exit 1; }

          # Fail fast if any file is empty
          [[ -s "${AZ_SRC}" ]] || { echo "::error::Azure JSON is empty: ${AZ_SRC}"; exit 1; }
          [[ -s "${AW_SRC}" ]] || { echo "::error::AWS JSON is empty: ${AW_SRC}"; exit 1; }
          [[ -s "${GC_SRC}" ]] || { echo "::error::GCP JSON is empty: ${GC_SRC}"; exit 1; }

          # Quick peek at top-level keys
          echo "== JSON KEYS PREVIEW =="
          echo "Azure:"
          jq 'keys' "${AZ_SRC}" | head -n 50 || true
          echo "AWS:"
          jq 'keys' "${AW_SRC}" | head -n 50 || true
          echo "GCP:"
          jq 'keys' "${GC_SRC}" | head -n 50 || true

          # Export for later steps
          echo "AZ_SRC=${AZ_SRC}" >> "$GITHUB_ENV"
          echo "AW_SRC=${AW_SRC}" >> "$GITHUB_ENV"
          echo "GC_SRC=${GC_SRC}" >> "$GITHUB_ENV"

      # --- Stage files into repo layout only after validation ---
      - name: Stage provider files into repo layout
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p data/azure data/aws data/gcp
          mkdir -p docs/data/azure docs/data/aws docs/data/gcp

          cp -f "${AZ_SRC}" data/azure/azure.prices.json
          cp -f "${AW_SRC}" data/aws/aws.prices.json
          cp -f "${GC_SRC}" data/gcp/gcp.prices.json

          cp -f data/azure/azure.prices.json docs/data/azure/azure.prices.json
          cp -f data/aws/aws.prices.json     docs/data/aws/aws.prices.json
          cp -f data/gcp/gcp.prices.json     docs/data/gcp/gcp.prices.json

      # --- Merge into data/prices.json, then copy to docs ---
      - name: Merge into data/prices.json
        shell: bash
        run: |
          set -euo pipefail

          # Assert again to be safe
          test -s data/azure/azure.prices.json
          test -s data/aws/aws.prices.json
          test -s data/gcp/gcp.prices.json

          jq -n \
            --slurpfile az data/azure/azure.prices.json \
            --slurpfile aw data/aws/aws.prices.json \
            --slurpfile gc data/gcp/gcp.prices.json \
            '{azure: $az[0], aws: $aw[0], gcp: $gc[0]}' \
            > data/prices.json

          cp -f data/prices.json docs/data/prices.json

      - name: Show merged keys
        run: |
          echo "Top-level keys of data/prices.json:"
          jq 'keys' data/prices.json | sed 's/^/  /'

      - name: Detect changes
        id: git_status
        run: |
          if git diff --quiet -- docs/data data; then
            echo "changed=false" >> "$GITHUB_OUTPUT"
          else
            echo "changed=true" >> "$GITHUB_OUTPUT"
          fi

      - name: Commit final merged cloud prices
        if: steps.git_status.outputs.changed == 'true'
        uses: stefanzweifel/git-auto-commit-action@v4
        with:
          commit_message: "Auto-update ALL cloud prices"
          file_pattern: |
            data/aws/aws.prices.json
            data/azure/azure.prices.json
            data/gcp/gcp.prices.json
            data/prices.json
            docs/data/prices.json
            docs/data/aws/aws.prices.json
            docs/data/azure/azure.prices.json
            docs/data/gcp/gcp.prices.json
