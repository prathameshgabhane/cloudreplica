name: Update All Cloud Prices

permissions:
  contents: write
  # NOTE: top-level permissions do NOT flow into reusable workflows; we set per-job below.

on:
  workflow_dispatch: {}
  schedule:
    - cron: "30 0 * * 1"   # Monday 00:30 UTC

concurrency:
  group: update-all-cloud-prices
  cancel-in-progress: false

jobs:
  # 1) Azure
  azure:
    uses: ./.github/workflows/update-azure.yml
    permissions:
      contents: read
      id-token: write       # OIDC for azure/login
    secrets: inherit

  # 2) AWS
  aws:
    needs: azure
    uses: ./.github/workflows/update-aws.yml
    permissions:
      contents: read
    secrets: inherit

  # 3) GCP
  gcp:
    needs: aws
    uses: ./.github/workflows/update-gcp.yml
    permissions:
      contents: read
      id-token: write       # OIDC for google-github-actions/auth
    secrets: inherit

  # 4) Aggregate (flat merge -> docs/data/prices.json for UI)
  aggregate:
    needs: gcp
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Ensure jq is available
        run: |
          if ! command -v jq >/dev/null 2>&1; then
            sudo apt-get update -y
            sudo apt-get install -y jq
          fi

      # Download artifacts from THIS workflow run
      - name: Download Azure artifact
        uses: actions/download-artifact@v4
        with:
          name: azure-prices
          path: _artifacts/azure

      - name: Download AWS artifact
        uses: actions/download-artifact@v4
        with:
          name: aws-prices
          path: _artifacts/aws

      - name: Download GCP artifact
        uses: actions/download-artifact@v4
        with:
          name: gcp-prices
          path: _artifacts/gcp

      - name: List downloaded artifacts
        run: |
          echo "== AZURE ARTIFACT ==" && find _artifacts/azure -maxdepth 6 -type f -print || true
          echo "== AWS ARTIFACT =="   && find _artifacts/aws   -maxdepth 6 -type f -print || true
          echo "== GCP ARTIFACT =="   && find _artifacts/gcp   -maxdepth 6 -type f -print || true

      - name: Validate provider JSONs are present and non-empty
        shell: bash
        run: |
          set -euo pipefail
          AZ_SRC=$(find _artifacts/azure -type f -name '*.json' -print -quit || true)
          AW_SRC=$(find _artifacts/aws   -type f -name '*.json' -print -quit || true)
          GC_SRC=$(find _artifacts/gcp   -type f -name '*.json' -print -quit || true)

          echo "AZ_SRC=${AZ_SRC}"
          echo "AW_SRC=${AW_SRC}"
          echo "GC_SRC=${GC_SRC}"

          [[ -n "${AZ_SRC}" && -s "${AZ_SRC}" ]] || { echo "::error::Azure artifact JSON missing/empty"; exit 1; }
          [[ -n "${AW_SRC}" && -s "${AW_SRC}" ]] || { echo "::error::AWS artifact JSON missing/empty"; exit 1; }
          [[ -n "${GC_SRC}" && -s "${GC_SRC}" ]] || { echo "::error::GCP artifact JSON missing/empty"; exit 1; }

          echo "== JSON KEYS PREVIEW =="
          echo "Azure:" && jq 'keys' "${AZ_SRC}" | head -n 50 || true
          echo "AWS:"   && jq 'keys' "${AW_SRC}" | head -n 50 || true
          echo "GCP:"   && jq 'keys' "${GC_SRC}" | head -n 50 || true

          echo "AZ_SRC=${AZ_SRC}" >> "$GITHUB_ENV"
          echo "AW_SRC=${AW_SRC}" >> "$GITHUB_ENV"
          echo "GC_SRC=${GC_SRC}" >> "$GITHUB_ENV"

      - name: Stage provider files into repo layout
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p data/azure data/aws data/gcp
          mkdir -p docs/data/azure docs/data/aws docs/data/gcp

          cp -f "${AZ_SRC}" data/azure/azure.prices.json
          cp -f "${AW_SRC}" data/aws/aws.prices.json
          cp -f "${GC_SRC}" data/gcp/gcp.prices.json

          cp -f data/azure/azure.prices.json docs/data/azure/azure.prices.json
          cp -f data/aws/aws.prices.json     docs/data/aws/aws.prices.json
          cp -f data/gcp/gcp.prices.json     docs/data/gcp/gcp.prices.json

      # ---------- FLAT MERGE â†’ data/prices.json then docs/data/prices.json ----------
      - name: Merge into data/prices.json (FLAT for UI)
        shell: bash
        run: |
          set -euo pipefail
          jq -n \
            --slurpfile az data/azure/azure.prices.json \
            --slurpfile aw data/aws/aws.prices.json \
            --slurpfile gc data/gcp/gcp.prices.json '
            {
              meta: {
                os:   (($az[0].meta.os + $aw[0].meta.os + $gc[0].meta.os) | unique),
                vcpu: (($az[0].meta.vcpu + $aw[0].meta.vcpu + $gc[0].meta.vcpu) | unique | sort),
                ram:  (($az[0].meta.ram  + $aw[0].meta.ram  + $gc[0].meta.ram ) | unique | sort)
              },
              azure: $az[0].compute,
              aws:   $aw[0].compute,
              gcp:   $gc[0].compute,
              generatedAt: (now | todate)
            }' > data/prices.json

          cp -f data/prices.json docs/data/prices.json

      - name: Show merged keys and counts
        run: |
          echo "Top-level keys of data/prices.json:" && jq 'keys' data/prices.json | sed 's/^/  /'
          echo "Counts: [azure, aws, gcp]" && jq '[.azure|length, .aws|length, .gcp|length]' data/prices.json

      - name: Check if files are ignored by .gitignore
        run: |
          echo "git check-ignore:"
          git check-ignore -v \
            data/azure/azure.prices.json \
            data/aws/aws.prices.json \
            data/gcp/gcp.prices.json \
            data/prices.json \
            docs/data/azure/azure.prices.json \
            docs/data/aws/aws.prices.json \
            docs/data/gcp/gcp.prices.json \
            docs/data/prices.json || true

      - name: Detect changes
        id: git_status
        run: |
          if git diff --quiet -- docs/data data; then
            echo "changed=false" >> "$GITHUB_OUTPUT"
          else
            echo "changed=true" >> "$GITHUB_OUTPUT"
          fi

      # Clean push: align to origin/main BEFORE staging to avoid rebase noise
      - name: Commit final merged cloud prices (force add)
        if: steps.git_status.outputs.changed == 'true'
        env:
          TZ: UTC
        run: |
          set -euo pipefail
          git config user.name  "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

          git fetch origin main
          git checkout main
          git reset --hard origin/main

          git add -f \
            data/azure/azure.prices.json \
            data/aws/aws.prices.json \
            data/gcp/gcp.prices.json \
            data/prices.json \
            docs/data/azure/azure.prices.json \
            docs/data/aws/aws.prices.json \
            docs/data/gcp/gcp.prices.json \
            docs/data/prices.json

          if git diff --cached --quiet; then
            echo "No changes to commit."
            exit 0
          fi

          git commit -m "Auto-update ALL cloud prices"
          git push
