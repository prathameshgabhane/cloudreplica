name: Update All Cloud Prices

permissions:
  contents: write
  # Note: top-level permissions DO NOT flow into reusable workflows.
  # You must declare permissions per 'uses:' job below.

on:
  workflow_dispatch: {}
  schedule:
    - cron: "30 0 * * 1"   # Monday 00:30 UTC

concurrency:
  group: update-all-cloud-prices
  cancel-in-progress: false

jobs:
  # 1) Fetch Azure PAYG data
  azure:
    uses: ./.github/workflows/update-azure.yml
    permissions:
      contents: read
      id-token: write        # required by update-azure.yml (azure/login OIDC)
    secrets: inherit

  # 2) Fetch AWS PAYG data (runs after Azure)
  aws:
    needs: azure
    uses: ./.github/workflows/update-aws.yml
    permissions:
      contents: read         # no OIDC needed by the AWS provider workflow we created
    secrets: inherit

  # 3) Fetch GCP PAYG data (runs after AWS)
  gcp:
    needs: aws
    uses: ./.github/workflows/update-gcp.yml
    permissions:
      contents: read
      id-token: write        # required by update-gcp.yml (google-github-actions/auth OIDC)
    secrets: inherit

  # 4) Aggregate, publish, commit
  aggregate:
    needs: gcp
    runs-on: ubuntu-latest
    permissions:
      contents: write        # commit merged outputs
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install jq (if missing)
        run: |
          if ! command -v jq >/dev/null 2>&1; then
            sudo apt-get update -y
            sudo apt-get install -y jq
          fi

      # Download provider artifacts from this same workflow run
      - name: Download Azure artifact
        uses: actions/download-artifact@v4
        with:
          name: azure-prices
          path: _artifacts/azure

      - name: Download AWS artifact
        uses: actions/download-artifact@v4
        with:
          name: aws-prices
          path: _artifacts/aws

      - name: Download GCP artifact
        uses: actions/download-artifact@v4
        with:
          name: gcp-prices
          path: _artifacts/gcp

      - name: Stage provider files into repo layout
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p data/azure data/aws data/gcp
          mkdir -p docs/data/azure docs/data/aws docs/data/gcp

          # Copy from artifacts into repo (data/)
          cp _artifacts/azure/*.json data/azure/azure.prices.json
          cp _artifacts/aws/*.json   data/aws/aws.prices.json
          cp _artifacts/gcp/*.json   data/gcp/gcp.prices.json

          # Also copy into docs/data/* for site consumption
          cp -f data/azure/azure.prices.json docs/data/azure/azure.prices.json
          cp -f data/aws/aws.prices.json     docs/data/aws/aws.prices.json
          cp -f data/gcp/gcp.prices.json     docs/data/gcp/gcp.prices.json

      - name: Merge into data/prices.json
        shell: bash
        run: |
          set -euo pipefail
          # If any provider file is missing, substitute {}
          [[ -f data/azure/azure.prices.json ]] || echo '{}' > data/azure/azure.prices.json
          [[ -f data/aws/aws.prices.json     ]] || echo '{}' > data/aws/aws.prices.json
          [[ -f data/gcp/gcp.prices.json     ]] || echo '{}' > data/gcp/gcp.prices.json

          jq -n \
            --slurpfile az data/azure/azure.prices.json \
            --slurpfile aw data/aws/aws.prices.json \
            --slurpfile gc data/gcp/gcp.prices.json \
            '{azure: $az[0], aws: $aw[0], gcp: $gc[0]}' \
            > data/prices.json

          # Copy merged to docs
          cp -f data/prices.json docs/data/prices.json

      - name: Sanity check merged JSON
        run: |
          echo "Top-level keys of data/prices.json:"
          jq 'keys' data/prices.json | sed 's/^/  /'

      - name: Detect changes
        id: git_status
        run: |
          if git diff --quiet -- docs/data data; then
            echo "changed=false" >> "$GITHUB_OUTPUT"
          else
            echo "changed=true" >> "$GITHUB_OUTPUT"
          fi

      - name: Commit final merged cloud prices
        if: steps.git_status.outputs.changed == 'true'
        uses: stefanzweifel/git-auto-commit-action@v4
        with:
          commit_message: "Auto-update ALL cloud prices"
          file_pattern: |
            data/aws/aws.prices.json
            data/azure/azure.prices.json
            data/gcp/gcp.prices.json
            data/prices.json
            docs/data/prices.json
            docs/data/aws/aws.prices.json
            docs/data/azure/azure.prices.json
            docs/data/gcp/gcp.prices.json
