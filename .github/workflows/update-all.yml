name: Update All Cloud Prices

permissions:
  contents: write

on:
  workflow_dispatch: {}
  schedule:
    - cron: "30 0 * * 1"

concurrency:
  group: update-all-cloud-prices
  cancel-in-progress: false

jobs:
  azure:
    uses: ./.github/workflows/update-azure.yml
    permissions:
      contents: read
      id-token: write
    secrets: inherit

  aws:
    needs: azure
    uses: ./.github/workflows/update-aws.yml
    permissions:
      contents: read
    secrets: inherit

  gcp:
    needs: aws
    uses: ./.github/workflows/update-gcp.yml
    permissions:
      contents: read
      id-token: write
    secrets: inherit

  aggregate:
    needs: gcp
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Ensure jq is available
        run: |
          if ! command -v jq >/dev/null 2>&1; then
            sudo apt-get update -y
            sudo apt-get install -y jq
          fi

      # ------------------------------ Download artifacts ------------------------------
      - name: Download Azure artifact
        uses: actions/download-artifact@v4
        with:
          name: azure-prices
          path: _artifacts/azure

      - name: Download AWS artifact
        uses: actions/download-artifact@v4
        with:
          name: aws-prices
          path: _artifacts/aws

      - name: Download GCP artifact
        uses: actions/download-artifact@v4
        with:
          name: gcp-prices
          path: _artifacts/gcp

      - name: List downloaded artifacts
        run: |
          echo "== AZURE ==" && find _artifacts/azure -type f -maxdepth 6 -print || true
          echo "== AWS =="   && find _artifacts/aws   -type f -maxdepth 6 -print || true
          echo "== GCP =="   && find _artifacts/gcp   -type f -maxdepth 6 -print || true

      # ------------------------------ Validate ------------------------------
      - name: Validate provider JSONs
        shell: bash
        run: |
          set -euo pipefail
          AZ_SRC=$(find _artifacts/azure -type f -name '*.json' -print -quit || true)
          AW_SRC=$(find _artifacts/aws   -type f -name '*.json' -print -quit || true)
          GC_SRC=$(find _artifacts/gcp   -type f -name '*.json' -print -quit || true)

          echo "AZ_SRC=$AZ_SRC"
          echo "AW_SRC=$AW_SRC"
          echo "GC_SRC=$GC_SRC"

          [[ -n "$AZ_SRC" && -s "$AZ_SRC" ]] || { echo "::error::Azure JSON missing"; exit 1; }
          [[ -n "$AW_SRC" && -s "$AW_SRC" ]] || { echo "::error::AWS JSON missing"; exit 1; }
          [[ -n "$GC_SRC" && -s "$GC_SRC" ]] || { echo "::error::GCP JSON missing"; exit 1; }

          echo "Azure:" && jq 'keys' "$AZ_SRC" | head -n 30 || true
          echo "AWS:"   && jq 'keys' "$AW_SRC" | head -n 30 || true
          echo "GCP:"   && jq 'keys' "$GC_SRC" | head -n 30 || true

          echo "AZ_SRC=$AZ_SRC" >> $GITHUB_ENV
          echo "AW_SRC=$AW_SRC" >> $GITHUB_ENV
          echo "GC_SRC=$GC_SRC" >> $GITHUB_ENV

      # ------------------------------ Stage into docs/data ------------------------------
      - name: Stage provider outputs
        shell: bash
        run: |
          mkdir -p docs/data/azure docs/data/aws docs/data/gcp
          cp -f "$AZ_SRC" docs/data/azure/azure.prices.json
          cp -f "$AW_SRC" docs/data/aws/aws.prices.json
          cp -f "$GC_SRC" docs/data/gcp/gcp.prices.json

      # ------------------------------ FLAT MERGE ------------------------------
      - name: Merge into docs/data/prices.json (FLAT)
        shell: bash
        run: |
          jq -n \
            --slurpfile az docs/data/azure/azure.prices.json \
            --slurpfile aw docs/data/aws/aws.prices.json \
            --slurpfile gc docs/data/gcp/gcp.prices.json '
            {
              meta: {
                os:   (($az[0].meta.os + $aw[0].meta.os + $gc[0].meta.os) | unique),
                vcpu: (($az[0].meta.vcpu + $aw[0].meta.vcpu + $gc[0].meta.vcpu) | unique | sort),
                ram:  (($az[0].meta.ram  + $aw[0].meta.ram  + $gc[0].meta.ram ) | unique | sort)
              },
              azure: $az[0].compute,
              aws:   $aw[0].compute,
              gcp:   $gc[0].compute
            }' > docs/data/prices.json

      # ------------------------------ Enforce FLAT ------------------------------
      - name: Enforce FLAT shape
        shell: bash
        run: |
          jq -e '
            (.azure|type=="array") and
            (.aws|type=="array") and
            (.gcp|type=="array")
          ' docs/data/prices.json >/dev/null || {
            echo "::error::prices.json is NOT FLAT"
            exit 1
          }

      # ------------------------------ buildInfo.json ------------------------------
      - name: Write buildInfo.json
        shell: bash
        run: |
          cat > docs/data/buildInfo.json <<'JSON'
          {
            "generatedAt": "__STAMP__"
          }
JSON
          sed -i "s#__STAMP__#$(date -u +%Y-%m-%dT%H:%M:%SZ)#" docs/data/buildInfo.json

      # ------------------------------ SAFE DIAGNOSTICS ------------------------------
      - name: Diagnostics (safe)
        shell: bash
        run: |
          set -euo pipefail

          echo "Keys:"
          jq 'keys' docs/data/prices.json || true

          echo "Types:"
          jq '{azure:(.azure|type), aws:(.aws|type), gcp:(.gcp|type)}' docs/data/prices.json || true

          echo "Counts:"
          jq '
            [
              (try ((.azure // []) | length) catch 0),
              (try ((.aws   // []) | length) catch 0),
              (try ((.gcp   // []) | length) catch 0)
            ]
          ' docs/data/prices.json || true

      # ------------------------------ Detect changes ------------------------------
      - name: Detect changes
        id: git_status
        run: |
          if git diff --quiet -- docs/data; then
            echo "changed=false" >> $GITHUB_OUTPUT
          else
            echo "changed=true" >> $GITHUB_OUTPUT
          fi

      # ------------------------------ Commit ------------------------------
      - name: Commit merged cloud prices
        if: steps.git_status.outputs.changed == 'true'
        shell: bash
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

          git fetch origin main
          git checkout main
          git reset --hard origin/main

          git add -f docs/data/azure/azure.prices.json
          git add -f docs/data/aws/aws.prices.json
          git add -f docs/data/gcp/gcp.prices.json
          git add -f docs/data/prices.json
          git add -f docs/data/buildInfo.json

          git commit -m "Auto-update ALL cloud prices"
          git push
