name: Fetch AWS Prices

permissions:
  contents: read          # provider does not commit; orchestrator will

on:
  workflow_call: {}
  workflow_dispatch: {}

concurrency:
  group: provider-aws
  cancel-in-progress: true

jobs:
  fetch-aws:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout repo (read-only)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Node (LTS)
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Ensure jq (for quick validation)
        run: |
          if ! command -v jq >/dev/null 2>&1; then
            sudo apt-get update -y
            sudo apt-get install -y jq
          fi

      # Optional: quick probe against AWS Price List (no auth required)
      - name: Probe AWS Price List API (sample)
        shell: bash
        env:
          AWS_REGION: "us-east-1"
        run: |
          set -euo pipefail
          CODE=$(curl -s -o /tmp/aws-price.json -w "%{http_code}" \
            "https://pricing.us-east-1.amazonaws.com/offers/v1.0/aws/AmazonEC2/current/${AWS_REGION}/index.json")
          echo "AWS Price List probe HTTP: ${CODE}"
          if [[ "${CODE}" != "200" ]]; then
            echo "::warning::AWS Price List probe failed (HTTP ${CODE}). Continuing; the fetch script may use a different endpoint or caching."
          else
            echo "Top-level keys (truncated):"
            jq 'keys' /tmp/aws-price.json | head -n 20 || true
          fi

      # Ephemeral workspace path (NOT committed to repo)
      - name: Ensure output directory
        run: mkdir -p data/aws

      # >>> Run your AWS fetcher (writes to data/aws/aws.prices.json)
      - name: Fetch AWS prices
        run: node scripts/providers/aws.fetch.js
        env:
          AWS_REGION: "us-east-1"
          # If your script supports more env flags, add them here:
          # AWS_CURRENCY: "USD"
          # AWS_FORCE_COMPOSE: "1"

      # Validate the output was created and is non-empty
      - name: Validate AWS output
        shell: bash
        run: |
          set -euo pipefail
          test -s data/aws/aws.prices.json
          echo "Output size (bytes):"
          wc -c data/aws/aws.prices.json
          echo "Top-level keys:"
          jq 'keys' data/aws/aws.prices.json | sed 's/^/  /' || true
          echo "Compute array length:"
          jq '.compute | length' data/aws/aws.prices.json || true

      # Upload artifact for orchestrator (normal mode)
      - name: Upload AWS pricing JSON (artifact)
        uses: actions/upload-artifact@v4
        with:
          name: aws-prices
          path: data/aws/aws.prices.json
          if-no-files-found: error
          retention-days: 7

      # =========================================
      # OPTIONAL DEBUG MODE â€” publish & commit directly to docs/data
      # Toggle via repository variable: DEBUG_PUBLISH=true
      # =========================================
      - name: Debug Publish to docs/data (optional)
        if: ${{ vars.DEBUG_PUBLISH == 'true' }}
        shell: bash
        run: |
          set -euo pipefail
          echo "DEBUG MODE ENABLED: Publishing AWS output directly to docs/data/aws"
          mkdir -p docs/data/aws
          cp -f data/aws/aws.prices.json docs/data/aws/aws.prices.json

      - name: Commit debug provider files (optional)
        if: ${{ vars.DEBUG_PUBLISH == 'true' }}
        shell: bash
        run: |
          set -euo pipefail
          git config user.name  "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

          # Align with remote to avoid rebase prompts
          git fetch origin main
          git checkout main
          git reset --hard origin/main

          git add -f docs/data/aws/aws.prices.json
          if git diff --cached --quiet; then
            echo "No changes to commit."
            exit 0
          fi

          git commit -m "Debug publish: AWS pricing update"
          git push
