name: Fetch Azure Prices

permissions:
  contents: read        # provider does not commit; orchestrator will
  id-token: write       # required for OIDC (azure/login@v2)

on:
  workflow_call: {}
  workflow_dispatch: {}

concurrency:
  group: provider-azure
  cancel-in-progress: true

jobs:
  fetch-azure:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout repo (read-only)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Node (LTS)
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Ensure jq (for quick validation)
        run: |
          if ! command -v jq >/dev/null 2>&1; then
            sudo apt-get update -y
            sudo apt-get install -y jq
          fi

      # Azure authentication (OIDC)
      - name: Azure Login (OIDC)
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      # Generate ARM (management) token for scripts that call ARM/Retail/ResourceSKUs
      - name: Generate ARM Token
        shell: bash
        run: |
          set -euo pipefail
          ARM_TOKEN=$(az account get-access-token \
            --resource https://management.azure.com/ \
            --query accessToken -o tsv)
          if [[ -z "${ARM_TOKEN}" ]]; then
            echo "::error::Failed to acquire ARM token via OIDC."
            exit 1
          fi
          echo "ARM_TOKEN=${ARM_TOKEN}" >> "$GITHUB_ENV"

      # Optional: probe that the token works against ARM (diagnostic)
      - name: Probe ARM (locations list)
        shell: bash
        env:
          SUB_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
          ARM_TOKEN: ${{ env.ARM_TOKEN }}
        run: |
          set -euo pipefail
          CODE=$(curl -s -o /tmp/arm.json -w "%{http_code}" \
            -H "Authorization: Bearer ${ARM_TOKEN}" \
            -H "Content-Type: application/json" \
            "https://management.azure.com/subscriptions/${SUB_ID}/locations?api-version=2020-01-01")
          echo "ARM probe HTTP: ${CODE}"
          if [[ "${CODE}" != "200" ]]; then
            echo "::warning::ARM probe failed (HTTP ${CODE}). The fetch script may still succeed if it uses a different API."
          else
            echo "Probe OK - sample keys:" && jq 'keys' /tmp/arm.json | head -n 20 || true
          fi

      # Output directory (UPDATED)
      - name: Ensure output directory
        run: mkdir -p docs/data/azure

      # >>> Run your Azure fetcher (UPDATED OUTPUT_PATH)
      - name: Fetch Azure prices
        run: node scripts/providers/azure.fetch.js
        env:
          ARM_TOKEN: ${{ env.ARM_TOKEN }}
          AZURE_REGION: "eastus"
          AZURE_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
          OUTPUT_PATH: "docs/data/azure/azure.prices.json"

      # Validate output (UPDATED path)
      - name: Validate Azure output
        shell: bash
        run: |
          set -euo pipefail
          test -s docs/data/azure/azure.prices.json
          echo "Output size (bytes):"
          wc -c docs/data/azure/azure.prices.json
          echo "Top-level keys:"
          jq 'keys' docs/data/azure/azure.prices.json | sed 's/^/  /' || true
          echo "Compute array length:"
          jq '.compute | length' docs/data/azure/azure.prices.json || true

      # Upload artifact (UPDATED path)
      - name: Upload Azure pricing JSON (artifact)
        uses: actions/upload-artifact@v4
        with:
          name: azure-prices
          path: docs/data/azure/azure.prices.json
          if-no-files-found: error
          retention-days: 7

      # =========================================
      # OPTIONAL DEBUG MODE â€” updated to avoid copy-to-self
      # =========================================
      - name: Debug Publish to docs/data (optional)
        if: ${{ vars.DEBUG_PUBLISH == 'true' }}
        shell: bash
        run: |
          set -euo pipefail
          echo "DEBUG MODE ENABLED: Publishing Azure output directly to docs/data/azure"
          # Main file is already in docs/data/azure; create a safe debug snapshot
          mkdir -p docs/data/azure/_debug
          cp -f docs/data/azure/azure.prices.json docs/data/azure/_debug/azure.prices.json

      - name: Commit debug provider files (optional)
        if: ${{ vars.DEBUG_PUBLISH == 'true' }}
        shell: bash
        run: |
          set -euo pipefail
          git config user.name  "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

          git fetch origin main
          git checkout main
          git reset --hard origin/main

          # Commit the main file exactly as before (unchanged behavior)
          git add -f docs/data/azure/azure.prices.json
          if git diff --cached --quiet; then
            echo "No changes to commit."
            exit 0
          fi

          git commit -m "Debug publish: Azure pricing update"
          git push
